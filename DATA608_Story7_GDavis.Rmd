---
title: "DATA608 - Story 7"
author: "Glen Dale Davis"
date: "2023-12-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Packages

```{r pacakages, warning = FALSE, message = FALSE}
library(tidyverse)
library(snakecase)
library(RColorBrewer)
library(janitor)

```

### Theme

```{r theme}
cur_theme <- theme_set(theme_classic())
greys <- brewer.pal(n = 9, name = "Greys")

```

### Data

```{r data}
#Critical minerals list
my_url1 <- "https://raw.githubusercontent.com/geedoubledee/data608_story7/main/data/critical_minerals.csv"
crit_min_df <- read.csv(my_url1)

#Net import reliance
my_url2 <- "https://raw.githubusercontent.com/geedoubledee/data608_story7/main/data/MCS2023_Fig2_Net_Import_Reliance.csv"
net_imp_rel_df <- read.csv(my_url2, encoding = "UTF-8")

#Minerals Security Partnership (MSP): 
#https://www.state.gov/minerals-security-partnership/#:~:text=The%20United%20States%20was%20joined,bolster%20critical%20mineral%20supply%20chains.
msp_sources <- c("Australia", "Canada", "Finland", "France", "Germany",
                 "Japan", "Republic of Korea", "Sweden", "United Kingdom",
                 "Europe")

#Belt and Road Initiative (BRI):
#https://greenfdc.org/countries-of-the-belt-and-road-initiative-bri/
my_url3 <- "https://raw.githubusercontent.com/geedoubledee/data608_story7/main/data/BRI-countries.csv"
bri_df <- read.csv(my_url3, skip = 3)
colnames(bri_df) <- to_screaming_snake_case(colnames(bri_df))

```

```{r merge}
rare_earths <- c("YTTERBIUM", "THULIUM", "TERBIUM", "SAMARIUM",
                 "PRASEODYMIUM", "NEODYMIUM", "LUTETIUM", "LANTHANUM",
                 "HOLMIUM", "GADOLINIUM", "EUROPIUM", "ERBIUM",
                 "DYSPROSIUM", "CERIUM")
plat_grp_metals <- c("IRIDIUM", "RHODIUM", "RUTHENIUM")
missing <- c("BERYLLIUM", "HAFNIUM")
patt <- c("ARSENIC,\\sall\\sforms", "GRAPHITE\\s\\(NATURAL\\)",
              "NIOBIUM\\s\\(COLUMBIUM\\)", "TITANIUM,\\ssponge",
              "ANTIMONY,\\smetal\\sand\\soxide",
              "TITANIUM\\sMINERAL\\sCONCENTRATES", "CHROMIUM,\\sall\\sforms ",
              "TIN,\\srefined", "ZINC,\\srefined", "ALUMINUM", "BAUXITE",
              "ALUMINA", "MAGNESIUM\\sMETAL", "MAGNESIUM\\sCOMPOUNDS",
              "ZIRCONIUM,\\sores\\sand\\sconcentrates",
              "RARE\\sEARTHS,\\scompounds\\sand\\smetals,\\sincluding\\slanthanides")
repl <- c("ARSENIC", "GRAPHITE", "NIOBIUM", "TITANIUM (SPONGE)",
          "ANTIMONY", "TITANIUM (MINERAL CONCENTRATES)", "CHROMIUM",
          "TIN", "ZINC", "ALUMINUM (METAL)", "ALUMINUM (BAUXITE)",
          "ALUMINUM (ALUMINA)", "MAGNESIUM (METAL)", "MAGNESIUM (COMPOUNDS)",
          "ZIRCONIUM", "RARE EARTHS")
names(repl) <- patt
net_imp_rel_df <- net_imp_rel_df |>
    mutate(Commodity = str_replace_all(Commodity, pattern = repl))
drop <- c("Crit_Min", "crit_min", "Source", "Major_Import_Sources_2018_2021")
new_cols <- c("Maj_Source_1", "Maj_Source_2", "Maj_Source_3", "Maj_Source_4")
main_df <- crit_min_df |>
    left_join(net_imp_rel_df, by = join_by(IMPORTED_AS == Commodity),
              relationship = "many-to-one") |>
    arrange(Import_Share_Rank, IMPORTED_AS, CRIT_MIN) |>
    mutate(Maj_Sources = trimws(Major_Import_Sources_2018_2021)) |>
    select(-all_of(drop)) |>
    separate_wider_delim(Maj_Sources,
                         delim = ", ", names = new_cols,
                         too_few = "align_start", cols_remove = FALSE)
colnames(main_df) <- to_screaming_snake_case(colnames(main_df))
main_df$NET_IMP_REL_PCT <- main_df$NET_IMPORT_RELIANCE_PCT_2022
main_df$NET_IMP_REL_PCT <- gsub(">95", "96", main_df$NET_IMP_REL_PCT)
main_df$NET_IMP_REL_PCT <- gsub(">75", "76", main_df$NET_IMP_REL_PCT)
main_df$NET_IMP_REL_PCT <- gsub(">50", "51", main_df$NET_IMP_REL_PCT)
main_df$NET_IMP_REL_PCT <- gsub("<50", "49", main_df$NET_IMP_REL_PCT)
main_df$NET_IMP_REL_PCT <- gsub(">25", "26", main_df$NET_IMP_REL_PCT)
main_df <- main_df |>
    select(-NET_IMPORT_RELIANCE_PCT_2022) |>
    mutate(NET_IMP_REL_PCT = as.numeric(NET_IMP_REL_PCT),
           DEPENDENCE = factor(case_when(NET_IMP_REL_PCT < 50 ~ "Medium",
                                         NET_IMP_REL_PCT < 75 ~ "High",
                                         NET_IMP_REL_PCT < 100 ~ "Very High",
                                         TRUE ~ "Complete"),
                               levels = c("Medium", "High",
                                          "Very High", "Complete")))

```

```{r sources}
sources <- c(unique(c(main_df$MAJ_SOURCE_1, main_df$MAJ_SOURCE_2,
                        main_df$MAJ_SOURCE_3, main_df$MAJ_SOURCE_4)))
sources <- as.data.frame(sources[!is.na(sources)])
colnames(sources) <- "Source"
sources <- sources |>
    arrange(Source)
patt <- c("Russian Federation")
repl <- c("Russia")
names(repl) <- patt
bri_df <- bri_df |>
    mutate(COUNTRY = str_replace_all(COUNTRY, pattern = repl))
bri_sources <- c(bri_df$COUNTRY, "China")
sources <- sources |>
    mutate(Category = case_when(Source %in% msp_sources ~ "Ally",
                                Source %in% bri_sources ~ "Competitor",
                                TRUE ~ "Neutral"))

```

```{r low_carbon_tech}
low_carbon_tech <- matrix(c(1, 1, 0, 0, 0, 1, 1, 1, 1, 0,
                            1, 0, 0, 1, 1, 1, 1, 1, 1, 1,
                            0, 0, 0, 0, 0, 1, 0, 1, 1, 1,
                            0, 0, 0, 0, 0, 1, 0, 0, 0, 0,
                            0, 1, 0, 0, 0, 0, 1, 0, 0, 0,
                            0, 0, 0, 0, 0, 1, 0, 0, 0, 0,
                            1, 0, 0, 1, 1, 1, 0, 1, 1, 1,
                            1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                            1, 1, 0, 1, 1, 1, 1, 1, 1, 1,
                            0, 0, 0, 1, 1, 0, 1, 1, 1, 0,
                            0, 0, 0, 0, 0, 1, 1, 1, 0, 0,
                            1, 1, 0, 1, 0, 1, 1, 0, 0, 0),
                          nrow = 12, ncol = 10, byrow = TRUE)
rownames(low_carbon_tech) <- c("Aluminum", "Chromium", "Cobalt", "Graphite",
                               "Indium", "Lithium", "Manganese", "Neodymium",
                               "Nickel", "Titanium", "Vanadium", "Zinc")
colnames(low_carbon_tech) <- c("Wind", "Solar Photovoltaic", "Concentrated Solar Power",
                               "Hydro", "Geothermal", "Energy Storage", "Nuclear",
                               "Coal", "Gas", "Carbon Capture and Storage")
low_carbon_tech <- as.data.frame(t(low_carbon_tech))
low_carbon_tech <- low_carbon_tech[, order(colSums(-low_carbon_tech))]
low_carbon_tech$ROW_TOTAL <- rowSums(low_carbon_tech)
low_carbon_tech <- low_carbon_tech |>
    filter(ROW_TOTAL > 0) |>
    rownames_to_column(var = "LOW_CARBON_TECHNOLOGY") |>
    arrange(desc(ROW_TOTAL))
skip <- c("LOW_CARBON_TECHNOLOGY", "ROW_TOTAL")
sel <- c("CRIT_MIN", "DEPENDENCE")
low_carbon_tech_piv <- low_carbon_tech |>
    pivot_longer(cols = -all_of(skip), names_to = "x", values_to = "val") |>
    group_by(x) |>
    mutate(COL_TOTAL = sum(val)) |>
    ungroup() |>
    mutate(X = str_to_upper(x)) |>
    left_join(main_df |> select(all_of(sel)),
              by = join_by(X == CRIT_MIN),
              relationship = "many-to-many",
              multiple = "first")|>
    select(-X)

```

```{r visualizations1}
palette <- brewer.pal(n = 4, name = "OrRd")
fil <- palette
title_str <- "Low-Carbon Technologies Rely on Critical Minerals the US Is Very Highly or\nCompletely Dependent on Importing, Endangering a Clean Energy Transition"
cap_str <- "https://www.worldbank.org/en/topic/extractiveindustries/brief/climate-smart-mining-minerals-for-climate-action"
p1 <- low_carbon_tech_piv |>
    filter(val == 1) |>
    ggplot() +
    geom_tile(aes(x = reorder(x, COL_TOTAL, decreasing = TRUE),
                  y = reorder(LOW_CARBON_TECHNOLOGY, ROW_TOTAL),
                  fill = DEPENDENCE),
                  col = "white") +
    scale_fill_manual(values = fil) +
    labs(fill = "Dependence Level",
         title = title_str,
         caption = cap_str) +
    theme(legend.position = "right",
          plot.title.position = "plot",
          plot.caption.position = "plot",
          plot.caption = element_text(hjust = 0),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
          axis.title = element_blank(),
          axis.line = element_blank(),
          axis.ticks = element_blank())
p1

```

```{r visualizations2}


```

